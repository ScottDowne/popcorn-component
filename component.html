<polymer-element name="ceci-popcorn-component" extends="ceci-element" attributes="make currenttime">
  <template>
    <link rel="stylesheet" href="component.css">
    <iframe id="make-iframe"></iframe>
    </div>
    <shadow></shadow>
    <script type="text/json" id="ceci-definition">
      {
        "name": "popcorn-component",
        "tags": "popcorn-component,wow,much-component",
        "thumbnail": "./thumbnail.png",
        "description": "Displays and controls a poprocn.webmaker.org make",
        "broadcasts": {
          "loaded": {
            "label": "Loaded",
            "description": "Popcorn make is ready to play"
          },
          "finished": {
            "label": "Finished",
            "description": "Popcorn make has finished"
          },
          "eventstart": {
            "label": "Track event start",
            "description": "Track event has started"
          },
          "eventend": {
            "label": "Track event end",
            "description": "Track event has ended"
          },
          "error": {
            "label": "Error",
            "description": "Popcorn make has an error"
          },
          "play": {
            "label": "Play",
            "description": "Popcorn make is playing"
          },
          "pause": {
            "label": "Pause",
            "description": "Popcorn make is now paused"
          }
        },
        "listeners": {
          "play": {
            "description": "Play the make",
            "label": "Play make"
          },
          "pause": {
            "description": "Pause the make",
            "label": "Pause make"
          },
          "rewind": {
            "description": "Rewind the make back to the start",
            "label": "Rewind make"
          }
        },
        "attributes": {
          "make": {
            "description": "url to popcorn.webmaker.org make",
            "label": "Make",
            "editable": "text"
          },
          "currenttime": {
            "description": "current time of the popcorn maker",
            "label": "Time",
            "editable": "number"
          }
        }
      }
    </script>
  </template>
    <script>
      Polymer("ceci-popcorn-component", {
        ready: function() {
          this.super();
        },
        make: "",
        currenttime: 0,
        makeChanged: function() {
          var iframe = this.$["make-iframe"],
              self = this;
          window.addEventListener( "message", function( e ) {
            if ( e.data.type === "loadedmetadata" ) {
              self.broadcast("loaded");
            } else if ( e.data.type === "play" ) {
              self.broadcast("play");
            } else if ( e.data.type === "pause" ) {
              self.broadcast("pause");
            } else if ( e.data.type === "trackend" ) {
              self.broadcast("eventend");
            } else if ( e.data.type === "trackstart" ) {
              self.broadcast("eventstart");
            } else if ( e.data.type === "ended" ) {
              self.broadcast("finished");
            }
          }, false );
          iframe.src = this.make;
        },
        currenttimeChanged: function() {
          if ( this.make ) {
            this.$["make-iframe"].contentWindow.postMessage({
              type: 'currentTime',
              currentTime: this.currenttime
            }, this.make);
          }
        },
        play: function() {
          this.$["make-iframe"].contentWindow.postMessage({type: "play"}, this.make);
        },
        pause: function() {
          this.$["make-iframe"].contentWindow.postMessage({type: "pause"}, this.make);
        },
        rewind: function() {
          this.$["make-iframe"].contentWindow.postMessage({
            type: 'currentTime',
            currentTime: 0
          }, this.make);
        }
      });
    </script>
</polymer-element>
